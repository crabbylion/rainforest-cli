machine:
  environment:
    GOPATH: "$HOME/.go_workspace"
    BUILD: "$GOPATH/src/github.com/rainforestapp/rainforest-cli"
    GODIST: "go1.7.3.linux-amd64.tar.gz"
  post:
    - mkdir -p download
    - test -e download/$GODIST || curl -o download/$GODIST https://storage.googleapis.com/golang/$GODIST
    - sudo rm -rf /usr/local/go
    - sudo tar -C /usr/local -xzf download/$GODIST

checkout:
  post:
    - mkdir -p $BUILD
    - rsync -av . $BUILD

dependencies:
  pre:
    - mkdir -p $GOPATH/bin
    - curl https://glide.sh/get | sh
  override:
    - cd $BUILD && glide install
  cache_directories:
    - "~/download"

test:
  override:
    - cd $BUILD && go test -v -race $(glide novendor)

deployment:
  stable:
    tag: /^v[0-9]+(\.[0-9]+)*$/
    owner: rainforestapp
    commands:
      - cd ~/download && curl -O https://bin.equinox.io/c/mBWdkfai63v/release-tool-stable-linux-amd64.zip
      - unzip release-tool-stable-linux-amd64.zip -d /usr/local/bin
      - cd $BUILD && echo $EQUINOX_KEY > ./equinox.key
      - equinox release --version=${CIRCLE_TAG:1} --platforms="darwin_amd64 linux_amd64 darwin_386 linux_386 windows_amd64 windows_386" --signing-key=equinox.key --app=$EQUINOX_APP_ID --token=$EQUINOX_ACC_TOKEN --channel stable -- -ldflags "-X main.releaseChannel=stable -X main.build=${CIRCLE_SHA1:0:8}" github.com/rainforestapp/rainforest-cli
      - equinox release --version=${CIRCLE_TAG:1} --platforms="darwin_amd64 linux_amd64 darwin_386 linux_386 windows_amd64 windows_386" --signing-key=equinox.key --app=$EQUINOX_APP_ID --token=$EQUINOX_ACC_TOKEN --channel beta -- -ldflags "-X main.releaseChannel=beta -X main.build=${CIRCLE_SHA1:0:8}" github.com/rainforestapp/rainforest-cli
      - equinox release --version=${CIRCLE_SHA1:0:8} --platforms="darwin_amd64 linux_amd64" --signing-key=equinox.key --app=$EQUINOX_APP_ID --token=$EQUINOX_ACC_TOKEN --channel dev -- -ldflags "-X main.releaseChannel=dev -X main.build=${CIRCLE_SHA1:0:8}" github.com/rainforestapp/rainforest-cli


  beta:
    tag: /^v[0-9]+(\.[0-9]+)*(\-(alpha|beta)\.[0-9]+)$/
    owner: rainforestapp
    commands:
      - cd ~/download && curl -O https://bin.equinox.io/c/mBWdkfai63v/release-tool-stable-linux-amd64.zip
      - unzip release-tool-stable-linux-amd64.zip -d /usr/local/bin
      - cd $BUILD && echo $EQUINOX_KEY > ./equinox.key
      - equinox release --version=${CIRCLE_TAG:1} --platforms="darwin_amd64 linux_amd64 darwin_386 linux_386 windows_amd64 windows_386" --signing-key=equinox.key --app=$EQUINOX_APP_ID --token=$EQUINOX_ACC_TOKEN --channel beta -- -ldflags "-X main.releaseChannel=beta -X main.build=${CIRCLE_SHA1:0:8}" github.com/rainforestapp/rainforest-cli
      - equinox release --version=${CIRCLE_SHA1:0:8} --platforms="darwin_amd64 linux_amd64" --signing-key=equinox.key --app=$EQUINOX_APP_ID --token=$EQUINOX_ACC_TOKEN --channel dev -- -ldflags "-X main.releaseChannel=dev -X main.build=${CIRCLE_SHA1:0:8}" github.com/rainforestapp/rainforest-cli

  dev:
    branch: develop
    owner: rainforestapp
    commands:
      - cd ~/download && curl -O https://bin.equinox.io/c/mBWdkfai63v/release-tool-stable-linux-amd64.zip
      - unzip release-tool-stable-linux-amd64.zip -d /usr/local/bin
      - cd $BUILD && echo $EQUINOX_KEY > ./equinox.key
      - equinox release --version=${CIRCLE_SHA1:0:8} --platforms="darwin_amd64 linux_amd64" --signing-key=equinox.key --app=$EQUINOX_APP_ID --token=$EQUINOX_ACC_TOKEN --channel dev -- -ldflags "-X main.releaseChannel=dev -X main.build=${CIRCLE_SHA1:0:8}" github.com/rainforestapp/rainforest-cli
